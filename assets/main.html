<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Resource Timeline</title>
    <script src="https://unpkg.com/timelines-chart"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src="https://d3js.org/d3-format.v1.min.js"></script>
    <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
    <script src="https://d3js.org/d3-time.v1.min.js"></script>
    <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale.v2.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
</head>
<body>

<div id="search" class="form-control-lg">
    <form>
        <input class="form-control" type="text" id="filterInput" placeholder="RegExp Filter">
    </form>
</div>

<div id="chart"></div>

<div class="modal" id="myModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resource</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre><code id="myModalContent"></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    var eventIntervals = [{"locator":{"type":"Pod","keys":{"namespace":"kube-system","name":"coredns-7db6d8ff4d-m8phn","uid":"f63880d7-5b90-4553-89e8-e1d559919b37"}},"change":{"type":"Metadata","diff":"@@ -1,7 +1,9 @@\n apiVersion: v1\n kind: Pod\n metadata:\n   creationTimestamp: 2024-07-19T08:14:05Z\n+  deletionGracePeriodSeconds: 30\n+  deletionTimestamp: 2024-07-19T09:17:56Z\n   generateName: coredns-7db6d8ff4d-\n   labels:\n     k8s-app: kube-dns\n@@ -175,7 +177,7 @@\n     kind: ReplicaSet\n     name: coredns-7db6d8ff4d\n     uid: 8c7a7d62-2832-48ef-a0cf-8d27c32f2a01\n-  resourceVersion: '9671'\n+  resourceVersion: '14620'\n   uid: f63880d7-5b90-4553-89e8-e1d559919b37\n spec:\n   affinity:\n"},"from":"2024-07-19T09:17:26.908773036Z","to":"2024-07-19T09:17:26.908775492Z"},{"locator":{"type":"Pod","keys":{"namespace":"kube-system","name":"coredns-7db6d8ff4d-55nrh","uid":"1abf54c6-3d2a-460c-920a-f27281f4db13"}},"change":{"type":"Spec","diff":"@@ -131,7 +131,7 @@\n     kind: ReplicaSet\n     name: coredns-7db6d8ff4d\n     uid: 8c7a7d62-2832-48ef-a0cf-8d27c32f2a01\n-  resourceVersion: '14624'\n+  resourceVersion: '14626'\n   uid: 1abf54c6-3d2a-460c-920a-f27281f4db13\n spec:\n   affinity:\n@@ -207,6 +207,7 @@\n       readOnly: true\n   dnsPolicy: Default\n   enableServiceLinks: true\n+  nodeName: kind-control-plane\n   nodeSelector:\n     kubernetes.io/os: linux\n   preemptionPolicy: PreemptLowerPriority\n@@ -258,5 +259,9 @@\n               fieldPath: metadata.namespace\n             path: namespace\n status:\n+  conditions:\n+  - lastTransitionTime: 2024-07-19T09:17:26Z\n+    status: 'True'\n+    type: PodScheduled\n   phase: Pending\n   qosClass: Burstable\n"},"from":"2024-07-19T09:17:26.931643377Z","to":"2024-07-19T09:17:26.931646370Z"},{"locator":{"type":"Pod","keys":{"namespace":"kube-system","name":"coredns-7db6d8ff4d-55nrh","uid":"1abf54c6-3d2a-460c-920a-f27281f4db13"}},"change":{"type":"Status","diff":"@@ -122,6 +122,47 @@\n     manager: kube-controller-manager\n     operation: Update\n     time: 2024-07-19T09:17:26Z\n+  - apiVersion: v1\n+    fieldsType: FieldsV1\n+    fieldsV1:\n+      f:status:\n+        f:conditions:\n+          k:{\"type\":\"ContainersReady\"}:\n+            .: {}\n+            f:lastProbeTime: {}\n+            f:lastTransitionTime: {}\n+            f:message: {}\n+            f:reason: {}\n+            f:status: {}\n+            f:type: {}\n+          k:{\"type\":\"Initialized\"}:\n+            .: {}\n+            f:lastProbeTime: {}\n+            f:lastTransitionTime: {}\n+            f:status: {}\n+            f:type: {}\n+          k:{\"type\":\"PodReadyToStartContainers\"}:\n+            .: {}\n+            f:lastProbeTime: {}\n+            f:lastTransitionTime: {}\n+            f:status: {}\n+            f:type: {}\n+          k:{\"type\":\"Ready\"}:\n+            .: {}\n+            f:lastProbeTime: {}\n+            f:lastTransitionTime: {}\n+            f:message: {}\n+            f:reason: {}\n+            f:status: {}\n+            f:type: {}\n+        f:containerStatuses: {}\n+        f:hostIP: {}\n+        f:hostIPs: {}\n+        f:startTime: {}\n+    manager: kubelet\n+    operation: Update\n+    subresource: status\n+    time: 2024-07-19T09:17:26Z\n   name: coredns-7db6d8ff4d-55nrh\n   namespace: kube-system\n   ownerReferences:\n@@ -131,7 +172,7 @@\n     kind: ReplicaSet\n     name: coredns-7db6d8ff4d\n     uid: 8c7a7d62-2832-48ef-a0cf-8d27c32f2a01\n-  resourceVersion: '14626'\n+  resourceVersion: '14630'\n   uid: 1abf54c6-3d2a-460c-920a-f27281f4db13\n spec:\n   affinity:\n@@ -261,7 +302,38 @@\n status:\n   conditions:\n   - lastTransitionTime: 2024-07-19T09:17:26Z\n+    status: 'False'\n+    type: PodReadyToStartContainers\n+  - lastTransitionTime: 2024-07-19T09:17:26Z\n+    status: 'True'\n+    type: Initialized\n+  - lastTransitionTime: 2024-07-19T09:17:26Z\n+    message: 'containers with unready status: [coredns]'\n+    reason: ContainersNotReady\n+    status: 'False'\n+    type: Ready\n+  - lastTransitionTime: 2024-07-19T09:17:26Z\n+    message: 'containers with unready status: [coredns]'\n+    reason: ContainersNotReady\n+    status: 'False'\n+    type: ContainersReady\n+  - lastTransitionTime: 2024-07-19T09:17:26Z\n     status: 'True'\n     type: PodScheduled\n+  containerStatuses:\n+  - image: registry.k8s.io/coredns/coredns:v1.11.1\n+    imageID: ''\n+    lastState: {}\n+    name: coredns\n+    ready: false\n+    restartCount: 0\n+    started: false\n+    state:\n+      waiting:\n+        reason: ContainerCreating\n+  hostIP: 10.89.0.21\n+  hostIPs:\n+  - ip: 10.89.0.21\n   phase: Pending\n   qosClass: Burstable\n+  startTime: 2024-07-19T09:17:26Z\n"},"from":"2024-07-19T09:17:26.943290351Z","to":"2024-07-19T09:17:26.943291894Z"},{"locator":{"type":"Pod","keys":{"namespace":"kube-system","name":"coredns-7db6d8ff4d-55nrh","uid":"1abf54c6-3d2a-460c-920a-f27281f4db13"}},"change":{"type":"Status","diff":"@@ -158,11 +158,18 @@\n         f:containerStatuses: {}\n         f:hostIP: {}\n         f:hostIPs: {}\n+        f:phase: {}\n+        f:podIP: {}\n+        f:podIPs:\n+          .: {}\n+          k:{\"ip\":\"10.244.0.10\"}:\n+            .: {}\n+            f:ip: {}\n         f:startTime: {}\n     manager: kubelet\n     operation: Update\n     subresource: status\n-    time: 2024-07-19T09:17:26Z\n+    time: 2024-07-19T09:17:28Z\n   name: coredns-7db6d8ff4d-55nrh\n   namespace: kube-system\n   ownerReferences:\n@@ -172,7 +179,7 @@\n     kind: ReplicaSet\n     name: coredns-7db6d8ff4d\n     uid: 8c7a7d62-2832-48ef-a0cf-8d27c32f2a01\n-  resourceVersion: '14630'\n+  resourceVersion: '14640'\n   uid: 1abf54c6-3d2a-460c-920a-f27281f4db13\n spec:\n   affinity:\n@@ -301,8 +308,8 @@\n             path: namespace\n status:\n   conditions:\n-  - lastTransitionTime: 2024-07-19T09:17:26Z\n-    status: 'False'\n+  - lastTransitionTime: 2024-07-19T09:17:28Z\n+    status: 'True'\n     type: PodReadyToStartContainers\n   - lastTransitionTime: 2024-07-19T09:17:26Z\n     status: 'True'\n@@ -321,19 +328,23 @@\n     status: 'True'\n     type: PodScheduled\n   containerStatuses:\n-  - image: registry.k8s.io/coredns/coredns:v1.11.1\n-    imageID: ''\n+  - containerID: containerd://efdc9eebf4bd087da72ec6ba60a1ea5f5e7740f6825680941fa1f5495fa2f92f\n+    image: registry.k8s.io/coredns/coredns:v1.11.1\n+    imageID: sha256:cbb01a7bd410dc08ba382018ab909a674fb0e48687f0c00797ed5bc34fcc6bb4\n     lastState: {}\n     name: coredns\n     ready: false\n     restartCount: 0\n-    started: false\n+    started: true\n     state:\n-      waiting:\n-        reason: ContainerCreating\n+      running:\n+        startedAt: 2024-07-19T09:17:27Z\n   hostIP: 10.89.0.21\n   hostIPs:\n   - ip: 10.89.0.21\n-  phase: Pending\n+  phase: Running\n+  podIP: 10.244.0.10\n+  podIPs:\n+  - ip: 10.244.0.10\n   qosClass: Burstable\n   startTime: 2024-07-19T09:17:26Z\n"},"from":"2024-07-19T09:17:28.374658825Z","to":"2024-07-19T09:17:28.374660742Z"},{"locator":{"type":"Pod","keys":{"namespace":"kube-system","name":"coredns-7db6d8ff4d-55nrh","uid":"1abf54c6-3d2a-460c-920a-f27281f4db13"}},"change":{"type":"Status","diff":"@@ -131,8 +131,6 @@\n             .: {}\n             f:lastProbeTime: {}\n             f:lastTransitionTime: {}\n-            f:message: {}\n-            f:reason: {}\n             f:status: {}\n             f:type: {}\n           k:{\"type\":\"Initialized\"}:\n@@ -151,8 +149,6 @@\n             .: {}\n             f:lastProbeTime: {}\n             f:lastTransitionTime: {}\n-            f:message: {}\n-            f:reason: {}\n             f:status: {}\n             f:type: {}\n         f:containerStatuses: {}\n@@ -179,7 +175,7 @@\n     kind: ReplicaSet\n     name: coredns-7db6d8ff4d\n     uid: 8c7a7d62-2832-48ef-a0cf-8d27c32f2a01\n-  resourceVersion: '14640'\n+  resourceVersion: '14643'\n   uid: 1abf54c6-3d2a-460c-920a-f27281f4db13\n spec:\n   affinity:\n@@ -314,15 +310,11 @@\n   - lastTransitionTime: 2024-07-19T09:17:26Z\n     status: 'True'\n     type: Initialized\n-  - lastTransitionTime: 2024-07-19T09:17:26Z\n-    message: 'containers with unready status: [coredns]'\n-    reason: ContainersNotReady\n-    status: 'False'\n+  - lastTransitionTime: 2024-07-19T09:17:28Z\n+    status: 'True'\n     type: Ready\n-  - lastTransitionTime: 2024-07-19T09:17:26Z\n-    message: 'containers with unready status: [coredns]'\n-    reason: ContainersNotReady\n-    status: 'False'\n+  - lastTransitionTime: 2024-07-19T09:17:28Z\n+    status: 'True'\n     type: ContainersReady\n   - lastTransitionTime: 2024-07-19T09:17:26Z\n     status: 'True'\n@@ -333,7 +325,7 @@\n     imageID: sha256:cbb01a7bd410dc08ba382018ab909a674fb0e48687f0c00797ed5bc34fcc6bb4\n     lastState: {}\n     name: coredns\n-    ready: false\n+    ready: true\n     restartCount: 0\n     started: true\n     state:\n"},"from":"2024-07-19T09:17:28.384204983Z","to":"2024-07-19T09:17:28.384207402Z"},{"locator":{"type":"Pod","keys":{"namespace":"kube-system","name":"coredns-7db6d8ff4d-m8phn","uid":"f63880d7-5b90-4553-89e8-e1d559919b37"}},"change":{"type":"Status","diff":"@@ -133,12 +133,14 @@\n             .: {}\n             f:lastProbeTime: {}\n             f:lastTransitionTime: {}\n+            f:reason: {}\n             f:status: {}\n             f:type: {}\n           k:{\"type\":\"Initialized\"}:\n             .: {}\n             f:lastProbeTime: {}\n             f:lastTransitionTime: {}\n+            f:reason: {}\n             f:status: {}\n             f:type: {}\n           k:{\"type\":\"PodReadyToStartContainers\"}:\n@@ -151,23 +153,18 @@\n             .: {}\n             f:lastProbeTime: {}\n             f:lastTransitionTime: {}\n+            f:reason: {}\n             f:status: {}\n             f:type: {}\n         f:containerStatuses: {}\n         f:hostIP: {}\n         f:hostIPs: {}\n         f:phase: {}\n-        f:podIP: {}\n-        f:podIPs:\n-          .: {}\n-          k:{\"ip\":\"10.244.0.9\"}:\n-            .: {}\n-            f:ip: {}\n         f:startTime: {}\n     manager: kubelet\n     operation: Update\n     subresource: status\n-    time: 2024-07-19T08:14:06Z\n+    time: 2024-07-19T09:17:32Z\n   name: coredns-7db6d8ff4d-m8phn\n   namespace: kube-system\n   ownerReferences:\n@@ -177,7 +174,7 @@\n     kind: ReplicaSet\n     name: coredns-7db6d8ff4d\n     uid: 8c7a7d62-2832-48ef-a0cf-8d27c32f2a01\n-  resourceVersion: '14620'\n+  resourceVersion: '14652'\n   uid: f63880d7-5b90-4553-89e8-e1d559919b37\n spec:\n   affinity:\n@@ -306,17 +303,20 @@\n             path: namespace\n status:\n   conditions:\n-  - lastTransitionTime: 2024-07-19T08:14:06Z\n-    status: 'True'\n+  - lastTransitionTime: 2024-07-19T09:17:32Z\n+    status: 'False'\n     type: PodReadyToStartContainers\n   - lastTransitionTime: 2024-07-19T08:14:05Z\n+    reason: PodCompleted\n     status: 'True'\n     type: Initialized\n-  - lastTransitionTime: 2024-07-19T08:14:06Z\n-    status: 'True'\n+  - lastTransitionTime: 2024-07-19T09:17:32Z\n+    reason: PodCompleted\n+    status: 'False'\n     type: Ready\n-  - lastTransitionTime: 2024-07-19T08:14:06Z\n-    status: 'True'\n+  - lastTransitionTime: 2024-07-19T09:17:32Z\n+    reason: PodCompleted\n+    status: 'False'\n     type: ContainersReady\n   - lastTransitionTime: 2024-07-19T08:14:05Z\n     status: 'True'\n@@ -327,18 +327,19 @@\n     imageID: sha256:cbb01a7bd410dc08ba382018ab909a674fb0e48687f0c00797ed5bc34fcc6bb4\n     lastState: {}\n     name: coredns\n-    ready: true\n+    ready: false\n     restartCount: 0\n-    started: true\n+    started: false\n     state:\n-      running:\n+      terminated:\n+        containerID: containerd://63a72a4106580dc165dd95ff0f493e60a2ee7966abc49a4f72b2e5926cef57f4\n+        exitCode: 0\n+        finishedAt: 2024-07-19T09:17:31Z\n+        reason: Completed\n         startedAt: 2024-07-19T08:14:06Z\n   hostIP: 10.89.0.21\n   hostIPs:\n   - ip: 10.89.0.21\n-  phase: Running\n-  podIP: 10.244.0.9\n-  podIPs:\n-  - ip: 10.244.0.9\n+  phase: Succeeded\n   qosClass: Burstable\n   startTime: 2024-07-19T08:14:05Z\n"},"from":"2024-07-19T09:17:32.078715794Z","to":"2024-07-19T09:17:32.078717926Z"},{"locator":{"type":"Pod","keys":{"namespace":"kube-system","name":"coredns-7db6d8ff4d-m8phn","uid":"f63880d7-5b90-4553-89e8-e1d559919b37"}},"change":{"type":"Status","diff":"@@ -160,6 +160,12 @@\n         f:hostIP: {}\n         f:hostIPs: {}\n         f:phase: {}\n+        f:podIP: {}\n+        f:podIPs:\n+          .: {}\n+          k:{\"ip\":\"10.244.0.9\"}:\n+            .: {}\n+            f:ip: {}\n         f:startTime: {}\n     manager: kubelet\n     operation: Update\n@@ -174,7 +180,7 @@\n     kind: ReplicaSet\n     name: coredns-7db6d8ff4d\n     uid: 8c7a7d62-2832-48ef-a0cf-8d27c32f2a01\n-  resourceVersion: '14652'\n+  resourceVersion: '14654'\n   uid: f63880d7-5b90-4553-89e8-e1d559919b37\n spec:\n   affinity:\n@@ -341,5 +347,8 @@\n   hostIPs:\n   - ip: 10.89.0.21\n   phase: Succeeded\n+  podIP: 10.244.0.9\n+  podIPs:\n+  - ip: 10.244.0.9\n   qosClass: Burstable\n   startTime: 2024-07-19T08:14:05Z\n"},"from":"2024-07-19T09:17:32.387901025Z","to":"2024-07-19T09:17:32.387902617Z"},{"locator":{"type":"Pod","keys":{"namespace":"kube-system","name":"coredns-7db6d8ff4d-m8phn","uid":"f63880d7-5b90-4553-89e8-e1d559919b37"}},"change":{"type":"Metadata","diff":"@@ -1,9 +1,9 @@\napiVersion: v1\n kind: Pod\n metadata:\n   creationTimestamp: 2024-07-19T08:14:05Z\n-  deletionGracePeriodSeconds: 30\n-  deletionTimestamp: 2024-07-19T09:17:56Z\n+  deletionGracePeriodSeconds: 0\n+  deletionTimestamp: 2024-07-19T09:17:26Z\n   generateName: coredns-7db6d8ff4d-\n   labels:\n     k8s-app: kube-dns\n@@ -180,7 +180,7 @@\n     kind: ReplicaSet\n     name: coredns-7db6d8ff4d\n     uid: 8c7a7d62-2832-48ef-a0cf-8d27c32f2a01\n-  resourceVersion: '14654'\n+  resourceVersion: '14655'\n   uid: f63880d7-5b90-4553-89e8-e1d559919b37\n spec:\n   affinity:\n"},"from":"2024-07-19T09:17:32.397579952Z","to":"2024-07-19T09:17:32.397582125Z"}]
</script>

<script>
    // Re-render the chart with input as a regexp. Timeout for event debouncing.
    $('#filterInput').on('input', (e) => {
        var $this = $(this);
        clearTimeout($this.data('timeout'));
        $this.data('timeout', setTimeout(() => {
            document.getElementById("chart").innerHTML = "";
            renderChart(new RegExp(e.target.value))
        }, 250));
    });

    // Prevent page refresh from pressing enter in input box
    $('#filterInput').keypress((e) => {
        if (event.which == '13') {
            event.preventDefault();
        }
    });

    function isPod(eventInterval) {
        return eventInterval.locator.type === "Pod";
    }

    function isSecret(eventInterval) {
        return eventInterval.locator.type === "Secret";
    }

    function isConfigMap(eventInterval) {
        return eventInterval.locator.type === "ConfigMap";
    }

    function isNode(eventInterval) {
        return eventInterval.locator.type === "Node";
    }


    function getDurationString(durationSeconds) {
        const seconds = durationSeconds % 60;
        const minutes = Math.floor(durationSeconds/60);
        var durationString = "[";
        if (minutes !== 0) {
            durationString += minutes + "m"
        }
        durationString += seconds + "s]";
        return durationString;
    }

    function defaultToolTip(item) {
        if (!item.change || !item.change.diff) {
            return '';
        }
        return item.change.diff
    }


    // Used for the actual locators displayed on the right hand side of the chart. Based on the origin go code that does
    // similar for whenever we serialize a locator to display.
    function buildLocatorDisplayString(i) {
        let keys = Object.keys(i.keys);
        keys = sortKeys(keys);

        let annotations = [];
        for (let k of keys) {
            annotations.push(`${k}/${i.keys[k]}`);
        }

        return annotations.join(' ');
    }

    function sortKeys(keys) {
        // Ensure these keys appear in this order. Other keys can be mixed in and will appear at the end in alphabetical order.
        const orderedKeys = ["namespace", "node", "pod", "uid", "server", "container", "shutdown", "row"];

        // Create a map to store the indices of keys in the orderedKeys array.
        // This will allow us to efficiently check if a key is in orderedKeys and find its position.
        const orderedKeyIndices = {};
        orderedKeys.forEach((key, index) => {
            orderedKeyIndices[key] = index;
        });

        // Define a custom sorting function that orders the keys based on the orderedKeys array.
        keys.sort((a, b) => {
            // Get the indices of keys a and b in orderedKeys.
            const indexA = orderedKeyIndices[a];
            const indexB = orderedKeyIndices[b];

            // If both keys exist in orderedKeys, sort them based on their order.
            if (indexA !== undefined && indexB !== undefined) {
                return indexA - indexB;
            }

            // If only one of the keys exists in orderedKeys, move it to the front.
            if (indexA !== undefined) {
                return -1;
            } else if (indexB !== undefined) {
                return 1;
            }

            // If neither key is in orderedKeys, sort alphabetically so we have predictable ordering.
            return a.localeCompare(b);
        });

        return keys;
    }

    function segmentTooltipFunc(d) {
        return '<span style="max-inline-size: min-content; display: inline-block;">'
        + '<pre style="text-align: left; color: white">' + d.labelVal + '</pre><br/>'
        + '<strong>From: </strong>' + new Date(d.timeRange[0]).toUTCString() + '<br>'
        + '<strong>To: </strong>' + new Date(d.timeRange[1]).toUTCString() + '</span>';
    }

    function createTimelineData(timelineVal, timelineData, rawEventIntervals, preconditionFunc, regex) {
        const data = {}
        var now = new Date();
        var earliest = rawEventIntervals.reduce(
            (accumulator, currentValue) => !currentValue.from || accumulator < new Date(currentValue.from) ? accumulator : new Date(currentValue.from),
            new Date(now.getTime() + 1),
        );
        var latest = rawEventIntervals.reduce(
            (accumulator, currentValue) => !currentValue.to || accumulator > new Date(currentValue.to) ? accumulator : new Date(currentValue.to),
            new Date(now.getTime() - 1),
        );
        rawEventIntervals.forEach((item) => {
            if (!preconditionFunc(item)) {
                return
            }
            var startDate = new Date(item.from)
            if (!item.from) {
                startDate = earliest;
            }
            var endDate = new Date(item.to)
            if (!item.to) {
                endDate = latest
            }
            let label = buildLocatorDisplayString(item.locator)
            let sub = ""
            let val = timelineVal
            if (typeof val === "function") {
                [label, sub, val] = timelineVal(item)
            }
            let section = data[label]
            if (!section) {
                section = {};
                data[label] = section
            }
            let ranges = section[sub]
            if (!ranges) {
                ranges = [];
                section[sub] = ranges
            }
            ranges.push({
                timeRange: [startDate, endDate],
                val: val,
                labelVal: defaultToolTip(item)
            });
        });
        for (const label in data) {
            const section = data[label]
            for (const sub in section) {
                if (regex == null || (regex != null && regex.test(label))) {
                    const data = section[sub];
                    const totalDurationSeconds = data.reduce(
                        (prev, curr) => prev + (curr.timeRange[1].getTime() - curr.timeRange[0].getTime())/1000,
                        0);

                    timelineData.push({label: label + sub + " " + getDurationString(totalDurationSeconds), data: data})
                }
            }
        }
    }

    function renderChart(regex) {
        var loc = window.location.href;

        var timelineGroups = []
        timelineGroups.push({group: "pod", data: []})
        createTimelineData("PodState", timelineGroups[timelineGroups.length - 1].data, eventIntervals, isPod, regex)

        timelineGroups.push({group: "secret", data: []})
        createTimelineData("Secret", timelineGroups[timelineGroups.length - 1].data, eventIntervals, isSecret, regex)

        timelineGroups.push({group: "configmap", data: []})
        createTimelineData("ConfigMap", timelineGroups[timelineGroups.length - 1].data, eventIntervals, isConfigMap, regex)

        timelineGroups.push({group: "node", data: []})
        createTimelineData("Node", timelineGroups[timelineGroups.length - 1].data, eventIntervals, isNode, regex)

        var segmentFunc = function (segment) {
            navigator.clipboard.writeText(segment.labelVal);
        }

        const el = document.querySelector('#chart');
        const myChart = TimelinesChart();
        myChart.
        data(timelineGroups).
        useUtc(true).
        zQualitative(true).
        enableAnimations(false).
        leftMargin(240).
        rightMargin(1550).
        maxLineHeight(20).
        maxHeight(10000).
        zoomX([new Date(eventIntervals[0].from), new Date(eventIntervals[eventIntervals.length - 1].to)]).
        onSegmentClick(segmentFunc).
        segmentTooltipContent(segmentTooltipFunc)
        (el);

        // force a minimum width for smaller devices (which otherwise get an unusable display)
        setTimeout(() => { if (myChart.width() < 3100) { myChart.width(3100) }}, 1)
    }

    renderChart(null)
</script>
</body>
</html>
